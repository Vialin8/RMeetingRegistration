<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>住院醫師座談會成效追蹤儀表板</title>

    <!-- React & Libraries -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-[#F5F5F3] text-slate-700 text-base">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip: RechartsTooltip, Legend, ResponsiveContainer, LabelList } = window.Recharts || {};

        // --- 設定與常數 ---
        const API_URL = "https://script.google.com/macros/s/AKfycbwp8wbNQaU0J9SQX6r1EUdhuAvnfDgsyfSXkIjtOHtGeXgu8hSN5_jKQ9_WqpFbvhkR9g/exec";

        // 會議設定 - 新增會議只需在此處添加
        const MEETINGS = [
            { id: '20251224', date: '2025/12/24', displayDate: '2025年12月24日 (週三)', time: '12:00', location: '554會議室', dateFilter: ['12/24/2025', '2025/12/24', '2025-12-24', '12/24'], photos: ['photos/20251224_01.jpg', 'photos/20251224_02.jpg', 'photos/20251224_03.jpg', 'photos/20251224_04.jpg'] },
            { id: '20260127', date: '2026/01/27', displayDate: '2026年01月27日 (週一)', time: '12:00', location: '563會議室', dateFilter: ['01/27/2026', '1/27/2026', '2026/01/27', '2026-01-27', '01/27', '1/27'], photos: ['photos/20260127_01.jpg', 'photos/20260127_02.jpg', 'photos/20260127_03.jpg', 'photos/20260127_04.jpg', 'photos/20260127_05.jpg'] }
        ];



        const COLORS = {
            primary: '#6B859E', secondary: '#7B9E89', accent: '#D6A28D', warning: '#B6A6A0',
            background: '#F5F5F3', text: '#4A5568', subText: '#718096',
        };

        const RESIDENT_KEYWORDS = ['住院醫師', 'R1', 'R2', 'R3', 'R4', 'R5', 'R6', 'R7', 'R8', 'R9',
            'LR1', 'LR2', 'LR3', 'LR4', 'LR5', '總醫師', 'CR', '研究員', '代理總醫師'];

        const Icons = {
            LayoutDashboard: () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1" /><rect width="7" height="5" x="14" y="3" rx="1" /><rect width="7" height="9" x="14" y="12" rx="1" /><rect width="7" height="5" x="3" y="16" rx="1" /></svg>,
            FileText: ({ size = 28 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" /></svg>,
            CheckCircle2: ({ size = 28 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><path d="m9 12 2 2 4-4" /></svg>,
            Clock: ({ size = 28 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></svg>,
            HelpCircle: ({ size = 28 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><path d="M12 17h.01" /></svg>,
            Users: ({ size = 28 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>,
            Calendar: ({ size = 28 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></svg>,
            ChevronRight: ({ size = 28 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6" /></svg>,
            Filter: ({ size = 28 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" /></svg>,
            Loader2: ({ size = 28, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>,
            AlertCircle: ({ size = 28 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></svg>,
            Stethoscope: ({ size = 28 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4.8 2.3A.3.3 0 1 0 5 2H4a2 2 0 0 0-2 2v5a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6V4a2 2 0 0 0-2-2h-1a.2.2 0 1 0 .3.3" /><path d="M8 15v1a6 6 0 0 0 6 6v0a6 6 0 0 0 6-6v-4" /><circle cx="20" cy="10" r="2" /></svg>,
            UserCheck: ({ size = 28 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><polyline points="16 11 18 13 22 9" /></svg>,
            Camera: ({ size = 28 }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" /><circle cx="12" cy="13" r="3" /></svg>
        };

        const StatusBadge = ({ status }) => {
            let color = COLORS.subText, bg = '#E2E8F0', Icon = Icons.HelpCircle;
            if (status && status.includes('已結案')) { color = '#2F855A'; bg = '#E6FFFA'; Icon = Icons.CheckCircle2; }
            else if (status && status.includes('進行中')) { color = '#C05621'; bg = '#FEEBC8'; Icon = Icons.Clock; }
            else if (status && (status.includes('待決議') || status.includes('未'))) { color = '#744210'; bg = '#FAF5FF'; Icon = Icons.HelpCircle; }
            return <span className={`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-base font-medium border whitespace-nowrap`} style={{ color, backgroundColor: bg, borderColor: `${color}30` }}><Icon size={16} /> {status || '未定義'}</span>;
        };

        const StatCard = ({ title, value, subtext, icon: Icon, color }) => (
            <div className="bg-white p-7 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-shadow">
                <div className="flex justify-between items-start">
                    <div>
                        <p className="text-lg font-medium text-slate-500 mb-1">{title}</p>
                        <h3 className="text-5xl font-bold" style={{ color: COLORS.text }}>{value}</h3>
                    </div>
                    <div className={`p-4 rounded-xl opacity-80`} style={{ backgroundColor: `${color}20`, color: color }}><Icon size={32} /></div>
                </div>
                {subtext && <p className="text-base text-slate-400 mt-3">{subtext}</p>}
            </div>
        );

        // 會議詳情頁面組件
        const MeetingPage = ({ meeting, trackingData, attendanceData }) => {
            // 過濾該會議的議題 - 日期已轉換為 YYYYMMDD 格式
            const meetingIssues = useMemo(() => {
                return trackingData.filter(item => item.date === meeting.id);
            }, [trackingData, meeting]);





            // 過濾該會議的出席人員
            const meetingAttendance = useMemo(() => {
                return attendanceData.filter(person =>
                    meeting.dateFilter.some(df => (person['場次'] || '').includes(df))
                );
            }, [attendanceData, meeting]);

            const stats = useMemo(() => {
                const residents = meetingAttendance.filter(p => {
                    const title = p['職稱'] || '';
                    const role = p['職級'] || '';
                    return role === '住院醫師' || RESIDENT_KEYWORDS.some(k => title.includes(k));
                });

                const residentDepts = [...new Set(residents.map(r => r['科別名'] || r['科別'] || '').filter(d => d))];

                const supervisors = meetingAttendance.filter(p => {
                    const role = p['職級'] || '';
                    return ['指導長官', '教學主管', '列席主管', '教學負責人', '主席'].includes(role);
                });

                const advisors = meetingAttendance.filter(p => p['職級'] === '指導長官').map(p => ({ name: p['姓名'], title: p['職稱'] }));
                const teachingSups = meetingAttendance.filter(p => p['職級'] === '教學主管').map(p => ({ name: p['姓名'], title: p['職稱'] }));
                const attendingSups = meetingAttendance.filter(p => p['職級'] === '列席主管' || p['職級'] === '主席').map(p => ({ name: p['姓名'], title: p['職稱'] }));
                const coordinators = meetingAttendance.filter(p => p['職級'] === '教學負責人').map(p => ({ name: p['姓名'], title: p['職稱'] }));

                return {
                    totalAttendees: meetingAttendance.length,
                    residentCount: residents.length,
                    totalIssues: meetingIssues.length,
                    residentDepts,
                    advisors,
                    teachingSups,
                    attendingSups,
                    coordinators
                };
            }, [meetingAttendance, meetingIssues]);

            return (
                <div className="animate-fade-in space-y-8">
                    {/* 會議標題區 */}
                    <div className="bg-gradient-to-r from-[#6B859E] to-[#556b80] rounded-2xl p-6 text-white shadow-lg">
                        <div className="flex flex-wrap items-center gap-4 mb-4 opacity-90 text-base">
                            <Icons.Calendar size={18} /> {meeting.displayDate} {meeting.time}
                            <span className="mx-2 hidden md:inline">|</span>
                            <span className="block md:inline w-full md:w-auto mt-1 md:mt-0">地點：{meeting.location}</span>
                        </div>
                        <h2 className="text-3xl md:text-4xl font-bold mb-6">{meeting.id}座談會</h2>

                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            {/* 住院醫師出席數 */}
                            <div className="bg-white/10 backdrop-blur-sm px-4 py-3 rounded-xl border border-white/20">
                                <div className="flex items-center gap-2 mb-1 opacity-90 text-sm"><Icons.Users size={16} /> 住院醫師出席數</div>
                                <span className="text-3xl font-bold">{stats.residentCount} <span className="text-base font-normal">人</span></span>
                            </div>
                            {/* 提案數量 */}
                            <div className="bg-white/10 backdrop-blur-sm px-4 py-3 rounded-xl border border-white/20">
                                <div className="flex items-center gap-2 mb-1 opacity-90 text-sm"><Icons.FileText size={16} /> 提案數量</div>
                                <span className="text-3xl font-bold">{stats.totalIssues} <span className="text-base font-normal">案</span></span>
                            </div>
                            {/* 住院醫師科別 */}
                            <div className="bg-white/10 backdrop-blur-sm px-4 py-3 rounded-xl border border-white/20 col-span-2 md:col-span-2 lg:col-span-4">
                                <div className="flex items-center gap-2 mb-2 opacity-90 text-sm"><Icons.Stethoscope size={16} /> 住院醫師科別</div>
                                <div className="flex flex-wrap gap-2">
                                    {stats.residentDepts.length > 0 ? stats.residentDepts.map((d, i) => <span key={i} className="text-sm bg-white/20 px-2.5 py-1 rounded text-white whitespace-nowrap">{d}</span>) : <span className="text-sm opacity-60">無資料</span>}
                                </div>
                            </div>
                            {/* 出席長官 */}
                            <div className="bg-white/10 backdrop-blur-sm px-4 py-3 rounded-xl border border-white/20 col-span-2 md:col-span-4 lg:col-span-6">
                                <div className="flex items-center gap-2 mb-2 opacity-90 text-sm"><Icons.UserCheck size={16} /> 出席長官</div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                                    {stats.advisors.length > 0 && <div><span className="text-xs text-white/70 block mb-1">指導長官</span><div className="flex flex-wrap gap-1.5">{stats.advisors.map((p, i) => <span key={i} className="text-sm bg-[#D6A28D]/90 px-2 py-0.5 rounded text-white">{p.name} {p.title}</span>)}</div></div>}
                                    {stats.teachingSups.length > 0 && <div><span className="text-xs text-white/70 block mb-1">教學主管</span><div className="flex flex-wrap gap-1.5">{stats.teachingSups.map((p, i) => <span key={i} className="text-sm bg-[#D6A28D]/90 px-2 py-0.5 rounded text-white">{p.name} {p.title}</span>)}</div></div>}
                                    {stats.attendingSups.length > 0 && <div><span className="text-xs text-white/70 block mb-1">列席主管</span><div className="flex flex-wrap gap-1.5">{stats.attendingSups.map((p, i) => <span key={i} className="text-sm bg-[#D6A28D]/90 px-2 py-0.5 rounded text-white">{p.name} {p.title}</span>)}</div></div>}
                                    {stats.coordinators.length > 0 && <div><span className="text-xs text-white/70 block mb-1">教學負責人</span><div className="flex flex-wrap gap-1.5">{stats.coordinators.map((p, i) => <span key={i} className="text-sm bg-[#D6A28D]/90 px-2 py-0.5 rounded text-white">{p.name} {p.title}</span>)}</div></div>}
                                    {stats.advisors.length === 0 && stats.teachingSups.length === 0 && stats.attendingSups.length === 0 && stats.coordinators.length === 0 && <span className="text-sm opacity-60">請在出席名單中填寫長官資料</span>}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* 議題追蹤區 */}
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100">
                        <div className="p-8 border-b border-slate-100 sticky top-0 bg-white z-10 rounded-t-2xl">
                            <h3 className="font-bold text-2xl text-slate-700 flex items-center gap-3">
                                <Icons.FileText className="text-slate-400" size={28} /> 本場次決議成效追蹤
                            </h3>
                        </div>
                        <div className="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                            {meetingIssues.length > 0 ? meetingIssues.map((issue, idx) => (
                                <div key={idx} className="border border-slate-200 rounded-xl p-8 bg-slate-50/50 flex flex-col h-full hover:border-slate-300 transition-all">
                                    <div className="flex justify-between items-start mb-5">
                                        <div className="flex items-center gap-3">
                                            <span className="text-base font-bold text-slate-500 bg-white border px-3 py-1 rounded">#{issue.id}</span>
                                            <span className="text-lg font-semibold text-slate-600">{issue.category}</span>
                                        </div>
                                        <StatusBadge status={issue.status} />
                                    </div>
                                    <h4 className="text-2xl font-bold text-slate-800 mb-6 flex-grow leading-tight">{issue.goal}</h4>
                                    <div className="grid grid-cols-2 gap-6 text-lg text-slate-600 mb-6 bg-white p-5 rounded-lg border border-slate-100">
                                        <div><span className="block text-sm text-slate-400 mb-1.5">提案者</span>{issue.proposer}</div>
                                        <div><span className="block text-sm text-slate-400 mb-1.5">負責窗口 (PIC)</span>{issue.pic || '-'}</div>
                                    </div>
                                    <div className="flex items-start gap-4 bg-[#F8F9FA] p-5 rounded-lg border-l-4 mt-auto" style={{ borderLeftColor: COLORS.primary }}>
                                        <div className="mt-1 text-slate-400 flex-shrink-0"><Icons.ChevronRight size={20} /></div>
                                        <div>
                                            <span className="block text-base font-bold text-slate-500 mb-1">
                                                {issue.progress ? '最新進度' : '會議決議'} {(issue.updateDate || issue.closeDate) ? `(${issue.updateDate || issue.closeDate})` : ''}
                                            </span>
                                            <p className="text-lg text-slate-700 leading-relaxed">{issue.progress || issue.resolution || '尚無資料'}</p>
                                        </div>
                                    </div>
                                </div>
                            )) : (
                                <div className="col-span-2 text-center py-12 text-slate-400">
                                    <Icons.FileText size={48} className="mx-auto mb-4 opacity-50" />
                                    <p className="text-xl">此場次尚無議題資料</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* 會議照片區 */}
                    {meeting.photos && meeting.photos.length > 0 && (
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-100">
                            <div className="p-8 border-b border-slate-100">
                                <h3 className="font-bold text-2xl text-slate-700 flex items-center gap-3">
                                    <Icons.Camera className="text-slate-400" size={28} /> 會議紀錄照片
                                </h3>
                            </div>
                            <div className="p-8">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {meeting.photos.map((photo, idx) => (
                                        <div key={idx} className="aspect-[4/3] rounded-xl overflow-hidden shadow-md hover:shadow-lg transition-shadow cursor-pointer group">
                                            <img
                                                src={photo}
                                                alt={`會議照片 ${idx + 1}`}
                                                className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                                onClick={() => window.open(photo, '_blank')}
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('overview');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [data, setData] = useState({ tracking: [], attendance: [], meta: {} });

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        setLoading(true);
                        const response = await fetch(`${API_URL}?t=${new Date().getTime()}`);
                        if (!response.ok) throw new Error('網路回應異常');
                        const result = await response.json();
                        setData(result);
                    } catch (err) {
                        console.error(err);
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, []);

            const trackingData = useMemo(() => {
                const mapped = data.tracking.map(item => {
                    // 狀態欄位判斷 - 檢查 '現狀' 欄位內容
                    let status = item['現狀'] || '';
                    // 如果現狀欄位是長文字（包含詳細說明），則判斷關鍵字
                    if (status.includes('已結案') || status.includes('結案')) {
                        status = '已結案';
                    } else if (status.includes('進行中') || status.includes('開發中') || status.includes('評估') || status.includes('規劃')) {
                        status = '進行中';
                    } else if (status.includes('待決議') || status.includes('待') || status === '') {
                        status = '待決議';
                    }

                    // 從提案者欄位提取科別 (格式如「病理部/張簡于聖醫師」)
                    const proposer = item['提案者'] || '';
                    const dept = proposer.includes('/') ? proposer.split('/')[0] : proposer;

                    // 場次轉換 - API 回傳 MM/DD/YYYY 格式（如 12/24/2025, 01/27/2026）
                    let meetingDate = item['場次'] || '';
                    // 轉換為統一格式 YYYYMMDD
                    if (meetingDate === '12/24/2025') {
                        meetingDate = '20251224';
                    } else if (meetingDate === '01/27/2026' || meetingDate === '1/27/2026') {
                        meetingDate = '20260127';
                    }
                    // 保留原始值以供後續匹配

                    return {
                        date: meetingDate,
                        id: item['序號'] || '',
                        category: item['議題類別'] || '未分類',
                        goal: item['具體目標'] || '',
                        proposer: proposer,
                        dept: dept,
                        pic: item['負責窗口 (PIC)'] || '',
                        milestone: item['預計里程碑'] || '',
                        status: status,
                        progress: item['追蹤報告'] || '',
                        resolution: item['會議決議'] || '',
                        updateDate: item['追蹤日期'] || '',
                        closeDate: item['結案日期'] || ''
                    };
                });

                const getStatusWeight = (status) => {
                    if (status.includes('待決議') || status.includes('未')) return 1;
                    if (status.includes('進行中')) return 2;
                    if (status.includes('已結案') || status.includes('完成')) return 3;
                    return 4;
                };

                return mapped.sort((a, b) => getStatusWeight(a.status) - getStatusWeight(b.status));
            }, [data.tracking]);

            const overviewStats = useMemo(() => {
                const total = trackingData.length;
                const completed = trackingData.filter(i => i.status.includes('已結案')).length;
                const inProgress = trackingData.filter(i => i.status.includes('進行中')).length;
                const pending = trackingData.filter(i => i.status.includes('待決議') || i.status.includes('未')).length;

                const pieData = [
                    { name: '已結案', value: completed, color: COLORS.secondary },
                    { name: '進行中', value: inProgress, color: COLORS.accent },
                    { name: '待決議', value: pending, color: COLORS.warning },
                ].filter(d => d.value > 0);

                const categoryCount = trackingData.reduce((acc, curr) => {
                    const cat = curr.category || '未分類';
                    acc[cat] = (acc[cat] || 0) + 1;
                    return acc;
                }, {});

                const barData = Object.keys(categoryCount).map(key => ({
                    name: key, count: categoryCount[key]
                }));

                return { total, completed, inProgress, pending, pieData, barData };
            }, [trackingData]);

            if (loading) return <div className="min-h-screen flex flex-col items-center justify-center space-y-4 bg-[#F5F5F3]"><div className="animate-spin text-slate-400"><Icons.Loader2 size={48} /></div><p className="text-xl text-slate-500 font-medium">資料同步中，請稍候...</p></div>;
            if (error) return <div className="min-h-screen flex flex-col items-center justify-center space-y-4 bg-[#F5F5F3]"><div className="text-red-500"><Icons.AlertCircle size={48} /></div><h3 className="text-2xl font-bold text-slate-700">資料載入失敗</h3><p className="text-lg text-slate-500">{error}</p><button onClick={() => window.location.reload()} className="px-6 py-3 bg-slate-200 rounded-lg text-slate-600 hover:bg-slate-300 text-lg">重新整理</button></div>;

            return (
                <div className="min-h-screen font-sans bg-[#F5F5F3] flex flex-col">
                    <nav className="bg-white border-b border-slate-200 px-8 py-5 flex flex-col md:flex-row justify-between items-center shadow-sm sticky top-0 z-20 gap-4">
                        <div className="flex items-center gap-4 w-full md:w-auto">
                            <div className="p-3 rounded-lg text-white" style={{ backgroundColor: COLORS.primary }}><Icons.LayoutDashboard size={28} /></div>
                            <div><h1 className="text-3xl font-bold tracking-tight" style={{ color: COLORS.text }}>住院醫師座談會</h1><p className="text-base text-slate-400">成效追蹤儀表板</p></div>
                        </div>
                        <div className="flex gap-3 bg-slate-100 p-1.5 rounded-lg w-full md:w-auto overflow-x-auto">
                            <button onClick={() => setActiveTab('overview')} className={`flex-1 md:flex-none px-6 py-3 rounded-md text-lg font-medium whitespace-nowrap transition-all duration-200 ${activeTab === 'overview' ? 'bg-white shadow-sm text-slate-700' : 'text-slate-500 hover:text-slate-700'}`}>現況追蹤 (總覽)</button>
                            {MEETINGS.map(m => (
                                <button key={m.id} onClick={() => setActiveTab(m.id)} className={`flex-1 md:flex-none px-6 py-3 rounded-md text-lg font-medium whitespace-nowrap transition-all duration-200 ${activeTab === m.id ? 'bg-white shadow-sm text-slate-700' : 'text-slate-500 hover:text-slate-700'}`}>{m.id}座談會</button>
                            ))}
                        </div>
                    </nav>

                    <main className="p-10 max-w-[95%] mx-auto space-y-10 flex-grow w-full">
                        {activeTab === 'overview' && (
                            <div className="animate-fade-in space-y-8">
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                    <StatCard title="總提案數" value={overviewStats.total} icon={Icons.FileText} color={COLORS.primary} subtext="累計至目前所有場次" />
                                    <StatCard title="已結案" value={overviewStats.completed} icon={Icons.CheckCircle2} color={COLORS.secondary} subtext="達成率追蹤" />
                                    <StatCard title="進行中" value={overviewStats.inProgress} icon={Icons.Clock} color={COLORS.accent} subtext="按進度執行中" />
                                    <StatCard title="待決議" value={overviewStats.pending} icon={Icons.HelpCircle} color={COLORS.warning} subtext="需跨部門協調" />
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <div className="lg:col-span-1 space-y-8">
                                        {/* Pie Chart */}
                                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-slate-700"><Icons.Filter size={20} /> 案件狀態分佈</h3>
                                            <div className="h-48 w-full">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <PieChart>
                                                        <Pie
                                                            data={overviewStats.pieData}
                                                            innerRadius={50}
                                                            outerRadius={70}
                                                            paddingAngle={5}
                                                            dataKey="value"
                                                            label={({ name, value }) => `${name}: ${value}`}
                                                            labelLine={{ strokeWidth: 1 }}
                                                            style={{ fontSize: '14px', fontWeight: '500' }}
                                                        >
                                                            {overviewStats.pieData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} />)}
                                                        </Pie>
                                                        <RechartsTooltip />
                                                        <Legend verticalAlign="bottom" height={36} wrapperStyle={{ fontSize: '16px' }} />
                                                    </PieChart>
                                                </ResponsiveContainer>
                                            </div>
                                        </div>
                                        {/* Bar Chart */}
                                        <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                                            <h3 className="font-bold text-xl mb-6 flex items-center gap-2 text-slate-700"><Icons.LayoutDashboard size={24} /> 議題類別分析</h3>
                                            <div className="h-80 w-full">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <BarChart data={overviewStats.barData} layout="vertical" margin={{ top: 5, right: 40, left: 40, bottom: 5 }}>
                                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                                                        <XAxis type="number" hide />
                                                        <YAxis dataKey="name" type="category" width={120} tick={{ fontSize: 16 }} />
                                                        <RechartsTooltip cursor={{ fill: 'transparent' }} />
                                                        <Bar dataKey="count" fill={COLORS.primary} radius={[0, 6, 6, 0]} barSize={32}>
                                                            <LabelList dataKey="count" position="right" fill="#666" fontSize={16} fontWeight="bold" />
                                                        </Bar>
                                                    </BarChart>
                                                </ResponsiveContainer>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden flex flex-col h-full">
                                        <div className="p-8 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0">
                                            <h3 className="font-bold text-2xl text-slate-700">全院議題追蹤清單</h3>
                                            <span className="text-base text-slate-400 bg-slate-50 px-4 py-2 rounded">即時更新</span>
                                        </div>
                                        <div className="overflow-x-auto flex-1">
                                            <table className="w-full text-left border-collapse">
                                                <thead className="bg-slate-50 text-slate-600 text-sm tracking-wider sticky top-0">
                                                    <tr>
                                                        <th className="p-3 font-bold w-12 text-center" style={{ writingMode: 'vertical-rl', textOrientation: 'mixed' }}>場次</th>
                                                        <th className="p-3 font-bold w-12 text-center" style={{ writingMode: 'vertical-rl', textOrientation: 'mixed' }}>狀態</th>
                                                        <th className="p-3 font-bold w-20 hidden lg:table-cell" style={{ writingMode: 'vertical-rl', textOrientation: 'mixed' }}>提出科別</th>
                                                        <th className="p-4 font-bold w-24 hidden lg:table-cell">議題類別</th>
                                                        <th className="p-4 font-bold">具體目標</th>
                                                        <th className="p-4 font-bold w-28 hidden md:table-cell">追蹤/結案日期</th>
                                                        <th className="p-4 font-bold hidden xl:table-cell" style={{ minWidth: '350px' }}>追蹤報告/會議決議</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100 text-base">
                                                    {trackingData.map((item, index) => (
                                                        <tr key={index} className="hover:bg-slate-50/50 transition-colors">
                                                            <td className="p-3 align-top text-slate-600 font-medium text-sm text-center" style={{ writingMode: 'vertical-rl', textOrientation: 'mixed' }}>{item.date}</td>
                                                            <td className="p-3 align-top text-center"><StatusBadge status={item.status} /></td>
                                                            <td className="p-3 align-top text-slate-600 hidden lg:table-cell text-sm" style={{ writingMode: 'vertical-rl', textOrientation: 'mixed' }}>{item.dept}</td>
                                                            <td className="p-4 align-top text-slate-500 hidden lg:table-cell">{item.category}</td>
                                                            <td className="p-4 align-top">
                                                                <div className="font-bold text-slate-800 leading-snug">{item.goal}</div>
                                                                <div className="lg:hidden mt-2 text-sm text-slate-400">
                                                                    <span>{item.dept}</span> · <span>{item.category}</span>
                                                                </div>
                                                            </td>
                                                            <td className="p-4 align-top text-slate-500 text-sm hidden md:table-cell">
                                                                {item.closeDate ? <div className="text-green-600">結案: {item.closeDate}</div> : null}
                                                                {item.updateDate ? <div>追蹤: {item.updateDate}</div> : null}
                                                            </td>
                                                            <td className="p-4 align-top text-slate-600 text-sm hidden xl:table-cell" style={{ minWidth: '350px', maxWidth: '500px' }}>
                                                                {item.progress && <div className="mb-2 whitespace-pre-wrap"><span className="font-semibold text-slate-700">追蹤:</span> {item.progress}</div>}
                                                                {item.resolution && <div className="text-slate-500 whitespace-pre-wrap"><span className="font-semibold">決議:</span> {item.resolution}</div>}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 動態渲染各場會議頁面 */}
                        {MEETINGS.map(m => (
                            activeTab === m.id && (
                                <MeetingPage
                                    key={m.id}
                                    meeting={m}
                                    trackingData={trackingData}
                                    attendanceData={data.attendance || []}
                                />
                            )
                        ))}
                    </main>

                    <footer className="bg-white border-t border-slate-200 py-6">
                        <div className="max-w-[95%] mx-auto text-center text-slate-400 text-base font-medium">
                            教學部 住院醫師組
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
